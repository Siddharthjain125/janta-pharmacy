// =============================================================================
// Janta Pharmacy - Prisma Schema
// =============================================================================
// This schema defines the database structure for the pharmacy system.
// 
// To apply changes:
//   npm run prisma:migrate     # Create and apply migration
//   npm run prisma:generate    # Regenerate Prisma client
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// USER DOMAIN
// =============================================================================

/// User account in the system
/// Primary identifier is phoneNumber (unique, required)
model User {
  id          String     @id @default(uuid())
  phoneNumber String     @unique @map("phone_number")
  name        String?
  email       String?    @unique
  role        UserRole   @default(CUSTOMER)
  status      UserStatus @default(ACTIVE)
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  // Relations
  orders      Order[]
  credentials Credential[]
  addresses   Address[]
  prescriptions Prescription[]

  @@index([phoneNumber])
  @@index([email])
  @@index([role])
  @@map("users")
}

/// User roles for authorization
enum UserRole {
  CUSTOMER
  STAFF
  PHARMACIST
  ADMIN
}

/// User account status
enum UserStatus {
  PENDING
  ACTIVE
  SUSPENDED
  DEACTIVATED
}

// =============================================================================
// AUTHENTICATION DOMAIN
// =============================================================================

/// User credentials for authentication
/// Separated from User to support multiple auth methods
model Credential {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  passwordHash String   @map("password_hash")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId])
  @@index([userId])
  @@map("credentials")
}

/// Refresh tokens for JWT authentication
model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  revokedAt DateTime? @map("revoked_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@index([revokedAt])
  @@map("refresh_tokens")
}

// =============================================================================
// PRESCRIPTION DOMAIN
// =============================================================================

/// Prescription submitted by a user and reviewed by admin
model Prescription {
  id              String             @id @default(uuid())
  userId          String             @map("user_id")
  fileReference   String             @map("file_reference")
  status          PrescriptionStatus @default(PENDING)
  createdAt       DateTime           @default(now()) @map("created_at")
  reviewedAt      DateTime?          @map("reviewed_at")
  rejectionReason String?            @map("rejection_reason")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("prescriptions")
}

enum PrescriptionStatus {
  PENDING
  APPROVED
  REJECTED
}

// =============================================================================
// ORDER DOMAIN
// =============================================================================

/// Address owned by a user (standalone aggregate)
model Address {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  label      String
  line1      String
  line2      String?
  city       String
  state      String
  postalCode String   @map("postal_code")
  country    String
  isDefault  Boolean  @default(false) @map("is_default")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isDefault])
  @@index([createdAt])
  @@map("addresses")
}

/// Order representing a customer's purchase
/// Status follows a state machine: DRAFT -> CREATED -> CONFIRMED -> PAID -> SHIPPED -> DELIVERED
/// Can be CANCELLED from most non-terminal states
model Order {
  id        String      @id @default(uuid())
  userId    String      @map("user_id")
  status    OrderStatus @default(DRAFT)
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")

  // Relations
  user  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  items OrderItem[]

  @@index([userId])
  @@index([status])
  @@index([userId, status])
  @@index([createdAt])
  @@map("orders")
}

/// Order status representing the lifecycle state
enum OrderStatus {
  DRAFT      // Cart - mutable, not yet committed
  CREATED    // Order placed, awaiting confirmation
  CONFIRMED  // Confirmed, awaiting payment
  PAID       // Payment received
  SHIPPED    // Order shipped
  DELIVERED  // Order delivered (terminal)
  CANCELLED  // Order cancelled (terminal)
}

/// Line item within an order
/// Captures product snapshot at time of adding (price, name won't change)
model OrderItem {
  id                 String   @id @default(uuid())
  orderId            String   @map("order_id")
  productId          String   @map("product_id")
  productName        String   @map("product_name")
  unitPriceAmount    Int      @map("unit_price_amount") // In minor units (paise)
  unitPriceCurrency  String   @default("INR") @map("unit_price_currency")
  quantity           Int
  addedAt            DateTime @default(now()) @map("added_at")

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@unique([orderId, productId])
  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

// =============================================================================
// CATALOG DOMAIN
// =============================================================================

/// Product in the pharmacy catalog
model Product {
  id                   String          @id @default(uuid())
  name                 String
  description          String?
  category             ProductCategory
  priceAmount          Int             @map("price_amount") // In minor units (paise)
  priceCurrency        String          @default("INR") @map("price_currency")
  requiresPrescription Boolean         @default(false) @map("requires_prescription")
  isActive             Boolean         @default(true) @map("is_active")
  createdAt            DateTime        @default(now()) @map("created_at")
  updatedAt            DateTime        @updatedAt @map("updated_at")

  @@index([category])
  @@index([isActive])
  @@index([requiresPrescription])
  @@index([name])
  @@map("products")
}

/// Product categories
enum ProductCategory {
  GENERAL
  PRESCRIPTION
  AYURVEDIC
  PERSONAL_CARE
  BABY_CARE
  HEALTH_DEVICES
  SUPPLEMENTS
  FIRST_AID
}
